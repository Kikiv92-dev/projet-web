name: CI/CD â€” Lint, Security Scan, Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- LINTING & BUILD PREP ---

      - name: Install PHP CLI
        run: sudo apt-get update && sudo apt-get install -y php-cli

      - name: PHP lint
        run: |
          set -e
          # Find all tracked PHP files
          files=$(git ls-files '*.php')
          if [ -z "$files" ]; then
            echo "No PHP files to lint"
          else
            echo "Running php -l on PHP files"
            # Loop through files and check syntax
            for f in $files; do php -l "$f"; done
          fi

      - name: Ensure curl available
        run: sudo apt-get install -y curl

      # --- HEALTHCHECK ---

      # Healthcheck Vercel target to ensure it's ready for ZAP scan
      - name: Healthcheck Deployment Target
        if: ${{ secrets.ZAP_TARGET_URL != '' }}
        run: |
          echo "Pinging target: ${{ secrets.ZAP_TARGET_URL }}"
          for i in {1..10}; do
            # Use '|| true' to prevent curl failure from immediately stopping the step
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.ZAP_TARGET_URL }}") || true
            echo "HTTP status: $status"
            
            # Check for 2xx or 3xx status codes
            if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
              echo "Target healthy"; exit 0
            fi
            
            sleep 2
          done
          echo "Target did not become healthy after 10 attempts"; exit 1

      # --- SONARCLOUD ANALYSIS (SAST) ---

      - name: Run SonarCloud analysis (optional)
        if: ${{ secrets.SONAR_TOKEN != '' && secrets.SONAR_PROJECT_KEY != '' && secrets.SONAR_ORGANIZATION != '' }}
        uses: SonarSource/sonarcloud-github-action@v2.3.0 # Using latest stable major version tag
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args:
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
          projectBaseDir: .

      # --- OWASP ZAP SCAN (DAST) ---

      # Replaced the manual 'docker run' script with the simplified GitHub Action
      - name: OWASP ZAP baseline scan (optional)
        if: ${{ secrets.ZAP_TARGET_URL != '' }}
        # The correct action name is zaproxy/action-baseline, typically pinned to a major version (v0)
        uses: zaproxy/action-baseline@v0
        with:
          target: ${{ secrets.ZAP_TARGET_URL }}
          # Set fail_action: true to fail the entire GitHub Action run if any alerts are found.
          # You can control which alerts (High/Medium/Low) cause a failure using a rules_file_name
          fail_action: true 
          # Optionally add a rules file for fine-grained control:
          # rules_file_name: .zap/zap-rules.tsv

      - name: Upload ZAP Scan Reports
        # Always run this step so reports are available even if the ZAP scan failed
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-scan-report
          path: |
            # These are the default filenames generated by the zap-baseline action
            zap_report.html
            zap_report.md
            # If you need the JSON report, you must pass -J to the cmd_options in the previous step
            # zap_report.json 

      # --- DEPLOYMENT ---
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: '--prod'
          working-directory: '.'