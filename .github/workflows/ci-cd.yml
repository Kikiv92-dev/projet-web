name: CI/CD â€” Lint, Security Scan, Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PHP CLI
        run: sudo apt-get update && sudo apt-get install -y php-cli

      - name: PHP lint
        run: |
          set -e
          files=$(git ls-files '*.php')
          if [ -z "$files" ]; then
            echo "No PHP files to lint"
          else
            echo "Running php -l on PHP files"
            for f in $files; do php -l "$f"; done
          fi

      - name: Ensure curl available
        run: sudo apt-get install -y curl

      - name: Healthcheck Vercel target (optional)
        if: ${{ secrets.ZAP_TARGET_URL != '' }}
        run: |
          echo "Pinging target: ${{ secrets.ZAP_TARGET_URL }}"
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.ZAP_TARGET_URL }}") || true
            echo "HTTP status: $status"
            if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
              echo "Target healthy"; exit 0
            fi
            sleep 2
          done
          echo "Target did not become healthy"; exit 1

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: '--prod'
          working-directory: '.'
