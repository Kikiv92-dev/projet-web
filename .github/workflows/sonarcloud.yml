# Ce workflow combine l'Analyse Statique (SAST) via SonarCloud
# et l'Analyse Dynamique (DAST) via OWASP ZAP Baseline Scan.
# Le DAST (ZAP) doit toujours s'exécuter APRES que l'application ait été déployée.

name: Combined Security Analysis (SonarCloud + ZAP)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read # Nécessaire pour checkout
  pull-requests: read # Nécessaire pour SonarCloud pour décorer les PRs

jobs:
  Analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # Nécessaire pour une analyse complète par SonarCloud et pour le build/déploiement.

      # ==========================================================
      # 1. ANALYSE STATIQUE (SAST) - SonarCloud
      # ==========================================================
      - name: Run SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@4006f663ecaf1f8093e8e4abb9227f6041f52216
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} 
        with:
          args:
            # Clés de votre projet SonarCloud (à adapter)
            -Dsonar.projectKey=Kikiv92-dev-projet-web
            -Dsonar.organization=kikiv92-dev
            # -Dsonar.sources= (laisser par défaut ou spécifier si besoin)
            # -Dsonar.tests=

      # ==========================================================
      # 2. ÉTAPE DE DÉPLOIEMENT (Placeholder)
      #    !!! L'application doit être déployée ici pour que ZAP puisse la scanner.
      #    Remplacez cette étape par votre logique de déploiement (Docker, Heroku, etc.).
      # ==========================================================
      - name: Deploy Application (Placeholder)
        run: |
          echo "Simulating application deployment to test environment..."
          # Définir l'URL cible de l'application déployée
          # Cette variable d'environnement DOIT pointer vers votre application en cours d'exécution.
          echo "ZAP_TARGET_URL=http://localhost:8080" >> $GITHUB_ENV
          echo "Deployment successful."
        # Remplacez "http://localhost:8080" par l'URL réelle de votre application de test.

      # ==========================================================
      # 3. ANALYSE DYNAMIQUE (DAST) - OWASP ZAP Baseline Scan
      # ==========================================================
      - name: Run OWASP ZAP Baseline Scan
        # Utilise l'image Docker de ZAP directement
        uses: docker://owasp/zap2docker-stable
        with:
          args: |
            zap-baseline.py \
            -t ${{ env.ZAP_TARGET_URL }} \
            -r zap_dast_report.html \
            -l WARN
        env:
          # Permet à ZAP de gérer plus facilement les problèmes de connexion/certificats dans les environnements CI
          # Ne pas utiliser en production !
          ZAP_API_KEY: 'changeme' 

      # ==========================================================
      # 4. EXPLOITATION DES RÉSULTATS
      # ==========================================================
      - name: Upload ZAP DAST Report
        uses: actions/upload-artifact@v4
        with:
          name: ZAP-DAST-Report
          path: zap_dast_report.html
          retention-days: 7